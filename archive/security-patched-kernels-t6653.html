<!DOCTYPE html>
<html dir="ltr" lang="en-gb">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
<title>Security patched kernels - antiX oldforums archive</title>
   
<link rel="stylesheet" href="../aaa_style.css">
<script type="text/javascript" src ="../aaa_oldforums.js"></script>
</head>
<body>
<div id="wrap" class="wrap">
<a id="top" class="top-anchor" accesskey="t"></a>

<div id="inner-wrap">
<ul id="nav-breadcrumbs" class="nav-breadcrumbs linklist navlinks clear-after" role="menubar">
<li class="scroll-breadcrumbs breadcrumbs">
<span class="crumb"><a href="./index.html" accesskey="h" data-navbar-reference="index"><span>antiX - oldforums archive</span></a> &raquo;&raquo; </span>

<span class="crumb"><a href="./orphaned-posts-f27/index.html"><span>Orphaned Posts</span></a> &raquo;&raquo; </span>

<span class="crumb"><a href="./development-old-f39/index.html"><span>Development (Old)</span></a> &raquo;&raquo; </span>

<span class="crumb"><a href="./kernels-f52/index.html"><span>Kernels</span></a></span>
</li>
</ul>

<div id="page-body" class="page-body" role="main">
<div class="postprofile_container postprofile_Left">
<div>
<div class="topictitleheader"><span class="statictopictitle">topic title: </span><span class="topic-titleb"><a href="./security-patched-kernels-t6653.html">Security patched kernels</a></div>
<div class="pagination">
5 posts
&bull; Page <strong>1</strong> of <strong>1</strong>
</div>
</div>

<div class="action-bar bar-top">
</div>
<div class="viewtopic_wrapper">
<div id="p_48774" class="post has-profile bg2">
<div class="inner">
<dl class="postprofile" id="profile48774">
<dt class="has-profile-rank has-avatar avatar-username">
<span class="username">anticapitalista</span>
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 5,955</span></div>

</div>
</div>
</dt>
<dd class="profile-rank">Site Admin</dd>
<dd class="profile-joined">Joined: 11 Sep 2007</dd>
</dl>
<div class="postbody">
<div id="post_content48774">
<time datetime="2016-10-27T12:14">posted: 2016-10-27 &nbsp; 12:14</time>
<span class="permalink"><a href="./security-patched-kernels-t6653.html#p48774" title="permalink">#1</a></span>

<div class="content">I'm sure some of you have heard about the COW kernel exploit<br>
<br>

<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"http://arstechnica.com/security/2016/10/most-serious-linux-privilege-escalation-bug-ever-is-under-active-exploit/"<br>linktext was:"http://arstechnica.com/security/2016/10 ... e-exploit/"<br>====================================<br>
<br>
<br>
I have patched the following set of kernels for jessie and testing/sid. They should appear some time in the repos. I do not have the time to patch every single kernel. Those that do not get patched will be removed from the repos.<br>
<br>
Patched for 32/64 bit and for libre versions as well.:<br>
<br>
4.0.5-antix.3<br>
4.4.10-antix.1<br>
4.6.2-antix.1<br>
<br>
The three kernels above also include pae versions.<br>
<br>
The 3.7.10 kernels will be kept, although they have not been patched. They probably don't need patching as they do not have any COW.<br>
<br>
This should keep users of antiX-13,2, antiX-15 and antiX-16 safe.<br>
<br>
Of course, users can always use the supported Debian and Debian backports kernels that have been patched. The liquorix kernels will be removed.<br>
<br>
4.8 kernels will be removed once I have uploaded 4.8.4.<br>
<br>
Some of you will get an automatic upgrade of the kernel through apt-get/synaptic. Others will need to search for the patched versions.<br>
<br>
I'll inform you when the kernels hit the repos.</div>
</div>
</div>

</div>
</div>
<div id="p_48776" class="post has-profile bg1">
<div class="inner">
<dl class="postprofile" id="profile48776">
<dt class="no-profile-rank has-avatar avatar-username">
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 1,028</span></div>

</div>
</div>
<span class="username">SamK</span>
</dt>
<dd class="profile-joined">Joined: 21 Aug 2011</dd>
</dl>
<div class="postbody">
<div id="post_content48776">

<time datetime="2016-10-27T13:04">posted: 2016-10-27 &nbsp; 13:04</time>
<span class="permalink"><a href="./security-patched-kernels-t6653.html#p48776" title="permalink">#2</a></span>

<div class="content">Thanks for that.<br>
<blockquote><div><cite>anticapitalista wrote:</cite>The 3.7.10 kernels will be kept, although they have not been patched. They probably don't need patching as they do not have any COW.</div></blockquote>A bit confusing in view of the following which appear in page link provided, or linked from it.<br>
<br>

<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"http://arstechnica.com/security/2016/10/most-serious-linux-privilege-escalation-bug-ever-is-under-active-exploit/"<br>linktext was:"http://arstechnica.com/security/2016/10 ... e-exploit/"<br>====================================<br>
<br>
"<em>A serious vulnerability that has been present for nine years in virtually all versions of the Linux operating system is under active exploit</em>"<br>
<br>

<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails"<br>linktext was:"https://github.com/dirtycow/dirtycow.gi ... ityDetails"<br>====================================<br>
<br>
"<em>The bug has existed since around 2.6.22 (released in 2007) and was fixed on Oct 18, 2016.</em>"</div>
</div>
</div>

</div>
</div>
<div id="p_48778" class="post has-profile bg2">
<div class="inner">
<dl class="postprofile" id="profile48778">
<dt class="has-profile-rank has-avatar avatar-username">
<span class="username">anticapitalista</span>
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 5,955</span></div>

</div>
</div>
</dt>
<dd class="profile-rank">Site Admin</dd>
<dd class="profile-joined">Joined: 11 Sep 2007</dd>
</dl>
<div class="postbody">
<div id="post_content48778">

<time datetime="2016-10-27T13:35">posted: 2016-10-27 &nbsp; 13:35</time>
<span class="permalink"><a href="./security-patched-kernels-t6653.html#p48778" title="permalink">#3</a></span>

<div class="content">I know, that is why I can't apply the patch. It does nothing. I need to look into this more.<br>
<br>
2 files get patched, one of which does not even exist in the 3.7.10 kernel.</div>
</div>
</div>

</div>
</div>
<div id="p_48785" class="post has-profile bg1">
<div class="inner">
<dl class="postprofile" id="profile48785">
<dt class="no-profile-rank has-avatar avatar-username">
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 88</span></div>

</div>
</div>
<span class="username">kmathern</span>
</dt>
<dd class="profile-joined">Joined: 25 Aug 2012</dd>
</dl>
<div class="postbody">
<div id="post_content48785">

<time datetime="2016-10-27T14:03">posted: 2016-10-27 &nbsp; 14:03</time>
<span class="permalink"><a href="./security-patched-kernels-t6653.html#p48785" title="permalink">#4</a></span>

 <div class="content"><blockquote><div><cite>anticapitalista wrote:</cite>I know, that is why I can't apply the patch. It does nothing. I need to look into this more.<br>
<br>
2 files get patched, one of which does not even exist in the 3.7.10 kernel.</div></blockquote>
The patch below, which is for the Wheezy 3.2 kernel, might work with your 3.7 kernel.<br>
<br>
It patches the include/linux/mm.h and mm/memory.c files, the other patches I've seen patch mm.h and a gup.c file.<br>
<br>
The patch is the debian/patches/bugfix/all/mm-gup-close-foll_map_private-race.patch file from this tarball here:<br>

<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"http://security.debian.org/debian-security/pool/updates/main/l/linux/linux_3.2.82-1.debian.tar.xz"<br>linktext was:"http://security.debian.org/debian-secur ... ian.tar.xz"<br>====================================<br>
<br>
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>From: Michal Hocko &lt;mhocko@suse.com&gt;
Date: Sun, 16 Oct 2016 11:55:00 +0200
Subject: mm, gup: close FOLL MAP_PRIVATE race

faultin_page drops FOLL_WRITE after the page fault handler did the CoW
and then we retry follow_page_mask to get our CoWed page. This is racy,
however because the page might have been unmapped by that time and so
we would have to do a page fault again, this time without CoW. This
would cause the page cache corruption for FOLL_FORCE on MAP_PRIVATE
read only mappings with obvious consequences.

This is an ancient bug that was actually already fixed once by Linus
eleven years ago in commit 4ceb5db9757a ("Fix get_user_pages() race
for write access") but that was then undone due to problems on s390
by commit f33ea7f404e5 ("fix get_user_pages bug") because s390 didn't
have proper dirty pte tracking until abf09bed3cce ("s390/mm: implement
software dirty bits"). This wasn't a problem at the time as pointed out
by Hugh Dickins because madvise relied on mmap_sem for write up until
0a27a14a6292 ("mm: madvise avoid exclusive mmap_sem") but since then we
can race with madvise which can unmap the fresh COWed page or with KSM
and corrupt the content of the shared page.

This patch is based on the Linus' approach to not clear FOLL_WRITE after
the CoW page fault (aka VM_FAULT_WRITE) but instead introduces FOLL_COW
to note this fact. The flag is then rechecked during follow_pfn_pte to
enforce the page fault again if we do not see the CoWed page. Linus was
suggesting to check pte_dirty again as s390 is OK now. But that would
make backporting to some old kernels harder. So instead let's just make
sure that vm_normal_page sees a pure anonymous page.

This would guarantee we are seeing a real CoW page. Introduce
can_follow_write_pte which checks both pte_write and falls back to
PageAnon on forced write faults which passed CoW already. Thanks to Hugh
to point out that a special care has to be taken for KSM pages because
our COWed page might have been merged with a KSM one and keep its
PageAnon flag.

Fixes: 0a27a14a6292 ("mm: madvise avoid exclusive mmap_sem")
Reported-by: Phil"not Paul" Oester &lt;kernel@linuxace.com&gt;
Disclosed-by: Andy Lutomirski &lt;luto@kernel.org&gt;
Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
Signed-off-by: Michal Hocko &lt;mhocko@suse.com&gt;
[bwh: Backported to 3.2:
 - Adjust filename, context, indentation
 - The 'no_page' exit path in follow_page() is different, so open-code the
   cleanup
 - Delete a now-unused label]
Signed-off-by: Ben Hutchings &lt;ben@decadent.org.uk&gt;
---
 include/linux/mm.h |  1 +
 mm/memory.c        | 39 ++++++++++++++++++++++++++++-----------
 2 files changed, 29 insertions(+), 11 deletions(-)

--- a/include/linux/mm.h
+++ b/include/linux/mm.h
@@ -1527,6 +1527,7 @@ struct page *follow_page(struct vm_area_
 #define FOLL_MLOCK    0x40    /* mark page as mlocked */
 #define FOLL_SPLIT    0x80    /* don't return transhuge pages, split them */
 #define FOLL_HWPOISON    0x100    /* check page is hwpoisoned */
+#define FOLL_COW    0x4000    /* internal GUP flag */
 
 typedef int (*pte_fn_t)(pte_t *pte, pgtable_t token, unsigned long addr,
             void *data);
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -1427,6 +1427,24 @@ int zap_vma_ptes(struct vm_area_struct *
 }
 EXPORT_SYMBOL_GPL(zap_vma_ptes);
 
+static inline bool can_follow_write_pte(pte_t pte, struct page *page,
+                    unsigned int flags)
+{
+    if (pte_write(pte))
+        return true;
+
+    /*
+     * Make sure that we are really following CoWed page. We do not really
+     * have to care about exclusiveness of the page because we only want
+     * to ensure that once COWed page hasn't disappeared in the meantime
+     * or it hasn't been merged to a KSM page.
+     */
+    if ((flags &amp; FOLL_FORCE) &amp;&amp; (flags &amp; FOLL_COW))
+        return page &amp;&amp; PageAnon(page) &amp;&amp; !PageKsm(page);
+
+    return false;
+}
+
 /**
  * follow_page - look up a page descriptor from a user-virtual address
  * @vma: vm_area_struct mapping @address
@@ -1509,10 +1527,13 @@ split_fallthrough:
     pte = *ptep;
     if (!pte_present(pte))
         goto no_page;
-    if ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte))
-        goto unlock;
 
     page = vm_normal_page(vma, address, pte);
+    if ((flags &amp; FOLL_WRITE) &amp;&amp; !can_follow_write_pte(pte, page, flags)) {
+        pte_unmap_unlock(ptep, ptl);
+        return NULL;
+    }
+
     if (unlikely(!page)) {
         if ((flags &amp; FOLL_DUMP) ||
             !is_zero_pfn(pte_pfn(pte)))
@@ -1555,7 +1576,7 @@ split_fallthrough:
             unlock_page(page);
         }
     }
-unlock:
+
     pte_unmap_unlock(ptep, ptl);
 out:
     return page;
@@ -1789,17 +1810,13 @@ int __get_user_pages(struct task_struct
                  * The VM_FAULT_WRITE bit tells us that
                  * do_wp_page has broken COW when necessary,
                  * even if maybe_mkwrite decided not to set
-                 * pte_write. We can thus safely do subsequent
-                 * page lookups as if they were reads. But only
-                 * do so when looping for pte_write is futile:
-                 * in some cases userspace may also be wanting
-                 * to write to the gotten user page, which a
-                 * read fault here might prevent (a readonly
-                 * page might get reCOWed by userspace write).
+                 * pte_write. We cannot simply drop FOLL_WRITE
+                 * here because the COWed page might be gone by
+                 * the time we do the subsequent page lookups.
                  */
                 if ((ret &amp; VM_FAULT_WRITE) &amp;&amp;
                     !(vma-&gt;vm_flags &amp; VM_WRITE))
-                    foll_flags &amp;= ~FOLL_WRITE;
+                    foll_flags |= FOLL_COW;
 
                 cond_resched();
             }
</code></pre></div></div>
</div>
</div>

</div>
</div>
<div id="p_48789" class="post has-profile bg2">
<div class="inner">
<dl class="postprofile" id="profile48789">
<dt class="has-profile-rank has-avatar avatar-username">
<span class="username">anticapitalista</span>
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 5,955</span></div>

</div>
</div>
</dt>
<dd class="profile-rank">Site Admin</dd>
<dd class="profile-joined">Joined: 11 Sep 2007</dd>
</dl>
<div class="postbody">
<div id="post_content48789">

<time datetime="2016-10-27T14:46">posted: 2016-10-27 &nbsp; 14:46</time>
<span class="permalink"><a href="./security-patched-kernels-t6653.html#p48789" title="permalink">#5</a></span>

 <div class="content">Many thanks kent. I'll give that a try.</div>
</div>
</div>

</div>
</div>
</div>
<div class="action-bar bar-bottom">

<div class="pagination">
5 posts
&bull; Page <strong>1</strong> of <strong>1</strong>
</div>
</div>
</div>
</div>
</div>
<div class="scrollToTopText"><a href="#top">goto top of page</a></div>

</div>
</body></html>
