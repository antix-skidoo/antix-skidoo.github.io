<!DOCTYPE html>
<html dir="ltr" lang="en-gb">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
<title>heads up: aufs is being dropped from Debian packaging - antiX oldforums archive</title>
   
<link rel="stylesheet" href="../aaa_style.css">
<script type="text/javascript" src ="../aaa_oldforums.js"></script>
</head>
<body>
<div id="wrap" class="wrap">
<a id="top" class="top-anchor" accesskey="t"></a>

<div id="inner-wrap">
<ul id="nav-breadcrumbs" class="nav-breadcrumbs linklist navlinks clear-after" role="menubar">
<li class="scroll-breadcrumbs breadcrumbs">
<span class="crumb"><a href="./index.html" accesskey="h" data-navbar-reference="index"><span>antiX - oldforums archive</span></a> &raquo;&raquo; </span>

<span class="crumb"><a href="./orphaned-posts-f27/index.html"><span>Orphaned Posts</span></a> &raquo;&raquo; </span>

<span class="crumb"><a href="./development-old-f39/index.html"><span>Development (Old)</span></a></span>
</li>
</ul>

<div id="page-body" class="page-body" role="main">
<div class="postprofile_container postprofile_Left">
<div>
<div class="topictitleheader"><span class="statictopictitle">topic title: </span><span class="topic-titleb"><a href="./heads-up-aufs-is-being-dropped-from-debian-packagi-t5408.html">heads up: aufs is being dropped from Debian packaging</a></div>
<div class="pagination">
3 posts
&bull; Page <strong>1</strong> of <strong>1</strong>
</div>
</div>

<div class="action-bar bar-top">
</div>
<div class="viewtopic_wrapper">
<div id="p_38453" class="post has-profile bg2">
<div class="inner">
<dl class="postprofile" id="profile38453">
<dt class="no-profile-rank has-avatar avatar-username">
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 1,445</span></div>

</div>
</div>
<span class="username">skidoo</span>
</dt>
<dd class="profile-joined">Joined: 09 Feb 2012</dd>
</dl>
<div class="postbody">
<div id="post_content38453">
<time datetime="2014-12-10T20:50">posted: 2014-12-10 &nbsp; 20:50</time>
<span class="permalink"><a href="./heads-up-aufs-is-being-dropped-from-debian-packagi-t5408.html#p38453" title="permalink">#1</a></span>

<div class="content">
<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"https://lists.debian.org/debian-kernel/2014/12/msg00136.html"<br>linktext was:"https://lists.debian.org/debian-kernel/ ... 00136.html"<br>====================================<br>

<blockquote class="uncited"><div>To: debian-live at lists.debian.org<br>
Subject: Replacing aufs with overlayfs<br>
From: Ben Hutchings <br>
Date: Tue, 09 Dec 2014<br>
<br>
The overlayfs union filesystem was included in Linux 3.18. I am assuming that this will cover the needs of Debian live systems, so I've<br>
dropped aufs from the Debian packaging. This is currently for experimental only, but you can expect this change to appear in unstable<br>
shortly after the jessie release.<br>
<br>
Please try the Linux 3.18 packages from experimental (they're not there yet, but should be soon) and check that overlayfs does what you need.
</div></blockquote></div>
</div>
</div>

</div>
</div>
<div id="p_38454" class="post has-profile bg1">
<div class="inner">
<dl class="postprofile" id="profile38454">
<dt class="no-profile-rank has-avatar avatar-username">
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 1,445</span></div>

</div>
</div>
<span class="username">skidoo</span>
</dt>
<dd class="profile-joined">Joined: 09 Feb 2012</dd>
</dl>
<div class="postbody">
<div id="post_content38454">

<time datetime="2014-12-10T20:55">posted: 2014-12-10 &nbsp; 20:55</time>
<span class="permalink"><a href="./heads-up-aufs-is-being-dropped-from-debian-packagi-t5408.html#p38454" title="permalink">#2</a></span>

<div class="content">another aufs news item:<br>

<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"http://sourceforge.net/p/aufs/mailman/aufs-users/?viewmonth=201412"<br>linktext was:"http://sourceforge.net/p/aufs/mailman/a ... nth=201412"<br>====================================<br>
:
<blockquote class="uncited"><div>J. R. Okajima<br>
Dec 8, 2014 <br>
<br>
Now linux-3.18 is released (and aufs3.18 too).<br>
At the end of this year, all aufs versions before aufs3.14 will become obsolete and go to the unsupport-stage.<br>
<br>
o news<br>
- XATTR/EA is supported, still in testing.<br>
Several new branch attributes are introduced.<br>
For details, refer to linux/Documentations/filesystem/aufs/design/06xattr.txt and the manual in aufs-util.git.<br>
- new mount options,"acl" and"noacl", are introduced.</div></blockquote></div>
</div>
</div>

</div>
</div>
<div id="p_38455" class="post has-profile bg2">
<div class="inner">
<dl class="postprofile" id="profile38455">
<dt class="no-profile-rank has-avatar avatar-username">
<div class="avatar-username-inner">
<div class="thread-user-detail">
<div class="detail-title-numposts"><span class="detail-title-numposts">Posts: 1,445</span></div>

</div>
</div>
<span class="username">skidoo</span>
</dt>
<dd class="profile-joined">Joined: 09 Feb 2012</dd>
</dl>
<div class="postbody">
<div id="post_content38455">

<time datetime="2014-12-10T21:13">posted: 2014-12-10 &nbsp; 21:13</time>
<span class="permalink"><a href="./heads-up-aufs-is-being-dropped-from-debian-packagi-t5408.html#p38455" title="permalink">#3</a></span>

<div class="content">overlayfs <strong>"documentation"</strong> retrieved from<br>

<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt"<br>linktext was:"https://www.kernel.org/doc/Documentatio ... rlayfs.txt"<br>====================================<br>
<br>
dated 1 Dec, 2014<br>
( <span style="color: green">The doc hasn't caught up with newly-added (recent weeks) features ~~ overlayfs reputedly now handles stacking <strong>multiple</strong> ro base layers</span> )<br>
<br>
"reputedly" b/c I'm skeptical whether overlayfs is ready for prime-time.<br>

<br>========= SCRAPER REMOVED AN EMBEDDED LINK HERE ===========<br>url was:"https://lkml.org/lkml/2014/11/21/768"<br>linktext was:"https://lkml.org/lkml/2014/11/21/768"<br>====================================<br>
<br>
Thru 22 Nov 2014, it was still"half-assed" enough to suffer race conditions on copy-up &amp; it choked on filenames containing comma chars...<br>
<blockquote class="uncited"><div>Written by: Neil Brown <br>
<br>
Overlay Filesystem<br>
==================<br>
<br>
This document describes a prototype for a new approach to providing overlay-filesystem functionality in Linux (sometimes referred to as union-filesystems).<br>
An overlay-filesystem tries to present a filesystem which is the result over overlaying one filesystem on top of the other.<br>
<br>
The result will inevitably fail to look exactly like a normal filesystem for various technical reasons. <br>
The expectation is that many use cases will be able to ignore these differences.<br>
<br>
This approach is 'hybrid' because the objects that appear in the filesystem do not all appear to belong to that filesystem. <br>
In many cases an object accessed in the union will be indistinguishable from accessing the corresponding object from the original filesystem.<br>
This is most obvious from the 'st_dev' field returned by stat(2).<br>
<br>
While directories will report an st_dev from the overlay-filesystem, <br>
all non-directory objects will report an st_dev from the lower or upper filesystem that is providing the object.<br>
Similarly st_ino will only be unique when combined with st_dev, and both of these can change over the lifetime of a non-directory object. <br>
Many applications and tools ignore these values and will not be affected.<br>
<br>
<br>
Upper and Lower<br>
---------------<br>
<br>
An overlay filesystem combines two filesystems - an 'upper' filesystem and a 'lower' filesystem. <br>
When a name exists in both filesystems, the object in the 'upper' filesystem is visible while the object in the 'lower' filesystem is either hidden<br>
or, in the case of directories, merged with the 'upper' object.<br>
<br>
It would be more correct to refer to an upper and lower 'directory tree' rather than 'filesystem' as it is quite possible<br>
for both directory trees to be in the same filesystem and there is no requirement that the root of a filesystem be given for either upper or lower.<br>
<br>
The lower filesystem can be any filesystem supported by Linux and does not need to be writable.<br>
The lower filesystem can even be another overlayfs. The upper filesystem will normally be writable<br>
and if it is it must support the creation of trusted.* extended attributes, and must provide valid d_type in readdir responses, so NFS is not suitable.<br>
<br>
A read-only overlay of two read-only filesystems may use any filesystem type.<br>
<br>
<br>
Directories<br>
-----------<br>
<br>
Overlaying mainly involves directories. If a given name appears in both upper and lower filesystems and refers to a non-directory in either,<br>
then the lower object is hidden - the name refers only to the upper object.<br>
<br>
Where both upper and lower objects are directories, a merged directory is formed.<br>
<br>
At mount time, the two directories given as mount options"lowerdir" and"upperdir" are combined into a merged directory:<br>
<br>
mount -t overlay overlay -olowerdir=/lower,upperdir=/upper, workdir=/work /merged<br>
<br>
The"workdir" needs to be an empty directory on the same filesystem as upperdir.<br>
<br>
Then whenever a lookup is requested in such a merged directory, the lookup is performed in each actual directory<br>
and the combined result is cached in the dentry belonging to the overlay filesystem. <br>
If both actual lookups find directories, both are stored and a merged directory is created, otherwise only one is stored: the upper if it exists, else the lower.<br>
<br>
Only the lists of names from directories are merged. Other content such as metadata and extended attributes are reported for the upper directory only.<br>
These attributes of the lower directory are hidden.<br>
<br>
<br>
whiteouts and opaque directories<br>
--------------------------------<br>
<br>
In order to support rm and rmdir without changing the lower filesystem, an overlay filesystem needs to record in the upper filesystem that files have been removed.<br>
This is done using whiteouts and opaque directories (non-directories are always opaque).<br>
<br>
A whiteout is created as a character device with 0/0 device number.<br>
When a whiteout is found in the upper level of a merged directory, any matching name in the lower level is ignored, and the whiteout itself is also hidden.<br>
<br>
A directory is made opaque by setting the xattr"trusted.overlay.opaque" to"y". <br>
Where the upper filesystem contains an opaque directory, any directory in the lower filesystem with the same name is ignored.<br>
<br>
<br>
readdir<br>
-------<br>
<br>
When a 'readdir' request is made on a merged directory, the upper and lower directories are each read and the name lists merged in the<br>
obvious way (upper is read first, then lower - entries that already exist are not re-added).<br>
This merged name list is cached in the 'struct file' and so remains as long as the file is kept open.<br>
If the directory is opened and read by two processes at the same time, they will each have separate caches. <br>
A seekdir to the start of the directory (offset 0) followed by a readdir will cause the cache to be discarded and rebuilt.<br>
<br>
This means that changes to the merged directory do not appear while a directory is being read. <br>
This is unlikely to be noticed by many programs.<br>
<br>
seek offsets are assigned sequentially when the directories are read.<br>
Thus if<br>
- read part of a directory<br>
- remember an offset, and close the directory<br>
- re-open the directory some time later<br>
- seek to the remembered offset<br>
<br>
there may be little correlation between the old and new locations in the list of filenames, particularly if anything has changed in the directory.<br>
<br>
Readdir on directories that are not merged is simply handled by the underlying directory (upper or lower).<br>
<br>
<br>
Non-directories<br>
---------------<br>
<br>
Objects that are not directories (files, symlinks, device-special files etc.) are presented either from the upper or lower filesystem as appropriate.<br>
When a file in the lower filesystem is accessed in a way the requires write-access, such as opening for write access, changing<br>
some metadata etc., the file is first copied from the lower filesystem to the upper filesystem (copy_up). <br>
Note that creating a hard-link also requires copy_up, though of course creation of a symlink does not.<br>
<br>
The copy_up may turn out to be unnecessary, for example if the file is opened for read-write but the data is not modified.<br>
<br>
The copy_up process first makes sure that the containing directory exists in the upper filesystem - creating it and any parents as necessary.<br>
It then creates the object with the same metadata (owner, mode, mtime, symlink-target etc.) and then if the object is a file, the<br>
data is copied from the lower to the upper filesystem. Finally any extended attributes are copied up.<br>
<br>
Once the copy_up is complete, the overlay filesystem simply provides direct access to the newly created file in the upper<br>
filesystem - future operations on the file are barely noticed by the overlay filesystem (though an operation on the name of the file such as<br>
rename or unlink will of course be noticed and handled).<br>
<br>
<br>
Non-standard behavior<br>
---------------------<br>
<br>
The copy_up operation essentially creates a new, identical file and moves it over to the old name.<br>
The new file may be on a different filesystem, so both st_dev and st_ino of the file may change.<br>
<br>
Any open files referring to this inode will access the old data and metadata.<br>
Similarly any file locks obtained before copy_up will not apply to the copied up file.<br>
<br>
On a file opened with O_RDONLY fchmod(2), fchown(2), futimesat(2) and fsetxattr(2) will fail with EROFS.<br>
<br>
If a file with multiple hard links is copied up, then this will"break" the link.<br>
Changes will not be propagated to other names referring to the same inode.<br>
<br>
Symlinks in /proc/PID/ and /proc/PID/fd which point to a non-directory object in overlayfs will not contain valid absolute paths,<br>
only relative paths leading up to the filesystem's root. This will be fixed in the future.<br>
<br>
Some operations are not atomic, for example a crash during copy_up or rename will leave the filesystem in an inconsistent state.<br>
This will be addressed in the future.<br>
<br>
<br>
Changes to underlying filesystems<br>
---------------------------------<br>
<br>
Offline changes, when the overlay is not mounted, are allowed to either the upper or the lower trees.<br>
<br>
Changes to the underlying filesystems while part of a mounted overlay filesystem are not allowed.<br>
If the underlying filesystem is changed, the behavior of the overlay is undefined, though it will not result in a crash or deadlock.</div></blockquote></div>
</div>
</div>

</div>
</div>
</div>
<div class="action-bar bar-bottom">

<div class="pagination">
3 posts
&bull; Page <strong>1</strong> of <strong>1</strong>
</div>
</div>
</div>
</div>
</div>
<div class="scrollToTopText"><a href="#top">goto top of page</a></div>

</div>
</body></html>
